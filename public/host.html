<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hohohoot</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .home-link {
            display: inline-block;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            transition: color 0.2s;
        }

        .home-link:hover {
            color: #a855f7;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
        }

        .header h1 span {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Cards */
        .card {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #fff;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: #fff;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #22c55e, #10b981);
            color: #fff;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid #3f3f46;
            color: #a1a1aa;
        }

        .btn-ghost:hover:not(:disabled) {
            background: #27272a;
            border-color: #52525b;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-full {
            width: 100%;
        }

        /* Button Group */
        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-group .btn {
            flex: 1;
            min-width: 140px;
        }

        /* PIN Display */
        .pin-display {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border-radius: 16px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            margin-bottom: 1.5rem;
        }

        .pin-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .pin-number {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: 0.2em;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Players List */
        .player-count {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .player-count span {
            color: #a855f7;
            font-weight: 600;
        }

        .players-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            min-height: 40px;
        }

        .player-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #27272a;
            border-radius: 20px;
            font-size: 0.875rem;
            color: #fff;
        }

        .player-chip .score {
            color: #a855f7;
            font-weight: 600;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #a1a1aa;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            font-family: inherit;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 10px;
            color: #fff;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::placeholder {
            color: #52525b;
        }

        .form-hint {
            font-size: 0.75rem;
            color: #52525b;
            margin-top: 0.5rem;
        }

        /* Question Form */
        .question-form {
            background: #27272a;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .question-form h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #a855f7;
            margin-bottom: 1rem;
        }

        .question-form .remove-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #3f3f46;
            border: none;
            color: #a1a1aa;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .question-form .remove-btn:hover {
            background: #ef4444;
            color: #fff;
        }

        .answer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        @media (max-width: 500px) {
            .answer-grid {
                grid-template-columns: 1fr;
            }
        }

        .answer-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }

        .answer-option input[type="radio"] {
            accent-color: #a855f7;
            flex-shrink: 0;
        }

        .answer-option input[type="text"] {
            flex: 1;
            min-width: 0;
            padding: 0.625rem 0.75rem;
            font-size: 0.875rem;
            background: #18181b;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            color: #fff;
            font-family: inherit;
        }

        .answer-option input[type="text"]:focus {
            outline: none;
            border-color: #6366f1;
        }

        .answer-option.red input[type="text"] {
            border-left: 3px solid #ef4444;
        }

        .answer-option.blue input[type="text"] {
            border-left: 3px solid #3b82f6;
        }

        .answer-option.yellow input[type="text"] {
            border-left: 3px solid #eab308;
        }

        .answer-option.green input[type="text"] {
            border-left: 3px solid #22c55e;
        }

        /* Question Display */
        .question-status {
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .answer-count {
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: #a855f7;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(168, 85, 247, 0.1);
            border-radius: 20px;
            display: inline-block;
            width: 100%;
        }

        .question-text {
            text-align: center;
            font-size: 1.75rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2rem;
            line-height: 1.3;
        }

        .answers-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .answer-box {
            padding: 1.5rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            text-align: center;
            transition: all 0.3s;
        }

        .answer-box.red {
            background: #ef4444;
        }

        .answer-box.blue {
            background: #3b82f6;
        }

        .answer-box.yellow {
            background: #eab308;
            color: #18181b;
        }

        .answer-box.green {
            background: #22c55e;
        }

        .answer-box.correct {
            box-shadow: 0 0 0 4px #22c55e, 0 0 30px rgba(34, 197, 94, 0.5);
            transform: scale(1.02);
            animation: correctPulseLoop 3.8s ease-in-out infinite;
        }

        @keyframes correctPulseLoop {

            /* First 3 pulses (0-1.8s) */
            0%,
            12% {
                box-shadow: 0 0 0 4px #22c55e, 0 0 30px rgba(34, 197, 94, 0.5);
            }

            6% {
                box-shadow: 0 0 0 8px #22c55e, 0 0 50px rgba(34, 197, 94, 0.8);
            }

            12%,
            28% {
                box-shadow: 0 0 0 4px #22c55e, 0 0 30px rgba(34, 197, 94, 0.5);
            }

            20% {
                box-shadow: 0 0 0 8px #22c55e, 0 0 50px rgba(34, 197, 94, 0.8);
            }

            28%,
            44% {
                box-shadow: 0 0 0 4px #22c55e, 0 0 30px rgba(34, 197, 94, 0.5);
            }

            36% {
                box-shadow: 0 0 0 8px #22c55e, 0 0 50px rgba(34, 197, 94, 0.8);
            }

            /* Pause (1.8s - 3.8s = 2s sleep) */
            44%,
            100% {
                box-shadow: 0 0 0 4px #22c55e, 0 0 30px rgba(34, 197, 94, 0.5);
            }
        }

        .timer-container.hidden {
            visibility: hidden;
        }

        /* Timer */
        .timer-container {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .timer-text {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.75rem;
        }

        .timer-text.warning {
            color: #eab308;
        }

        .timer-text.danger {
            color: #ef4444;
        }

        .timer-bar {
            height: 6px;
            background: #27272a;
            border-radius: 3px;
            overflow: hidden;
        }

        .timer-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #eab308, #ef4444);
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        /* Leaderboard */
        .leaderboard-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 1.5rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #27272a;
            border-radius: 12px;
            margin-bottom: 0.75rem;
        }

        .leaderboard-rank {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 10px;
            background: #3f3f46;
            color: #fff;
        }

        .leaderboard-item:nth-child(1) .leaderboard-rank {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .leaderboard-item:nth-child(2) .leaderboard-rank {
            background: linear-gradient(135deg, #94a3b8, #64748b);
        }

        .leaderboard-item:nth-child(3) .leaderboard-rank {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }

        .leaderboard-name {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .leaderboard-score {
            font-size: 1.25rem;
            font-weight: 700;
            color: #a855f7;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .mb-3 {
            margin-bottom: 1.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mt-3 {
            margin-top: 1.5rem;
        }

        .questions-scroll {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .questions-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .questions-scroll::-webkit-scrollbar-track {
            background: #27272a;
            border-radius: 3px;
        }

        .questions-scroll::-webkit-scrollbar-thumb {
            background: #52525b;
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }

            .card {
                padding: 1.5rem;
            }

            .pin-number {
                font-size: 2.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                min-width: auto;
            }

            .answers-display {
                grid-template-columns: 1fr;
            }

            .answer-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================
            PROMPT 2 ‚Äî Countdown Overlay
           ============================ */
        .countdown-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(10, 10, 10, 0.88);
            z-index: 9999;
        }

        .countdown-number {
            font-size: 6rem;
            font-weight: 800;
            letter-spacing: 0.05em;
            color: #fff;
            line-height: 1;
            transform: scale(1);
            opacity: 1;
        }

        .countdown-number.animate {
            animation: countdownFadeIn 0.35s ease;
        }

        @keyframes countdownFadeIn {
            from {
                opacity: 0;
                transform: scale(0.88);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Question screen quick fade-in */
        .screen-fade-in {
            animation: screenFadeIn 0.25s ease;
        }

        @keyframes screenFadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="/" class="home-link">‚Üê Back to Menu</a>
            <h1>üéØ <span>Hohohoot</span> Host</h1>
        </div>

        <!--  2: Countdown Overlay -->
        <div id="countdown-overlay" class="countdown-overlay hidden">
            <div id="countdown-number" class="countdown-number">3</div>
        </div>

        <!-- Quiz Selection Screen -->
        <div id="quiz-selection-screen" class="card">
            <div class="card-title text-center">Choose Your Quiz</div>
            <div class="btn-group">
                <button id="use-example-btn" class="btn btn-success">üìö Example Quiz</button>
                <button id="create-custom-btn" class="btn btn-primary">‚úèÔ∏è Create Custom</button>
            </div>
        </div>

        <!-- Custom Quiz Creation Screen -->
        <div id="quiz-creation-screen" class="card hidden">
            <div class="card-title">Create Your Quiz</div>
            <div id="questions-container" class="questions-scroll mb-2">
                <!-- Questions will be added here -->
            </div>
            <button id="add-question-btn" class="btn btn-success btn-full mb-2">‚ûï Add Question</button>
            <div class="btn-group">
                <button id="create-quiz-btn" class="btn btn-primary" disabled>Create & Start</button>
                <button id="cancel-quiz-btn" class="btn btn-ghost">Cancel</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="card hidden">
            <div class="pin-display">
                <div class="pin-label">Game PIN</div>
                <div class="pin-number" id="game-pin">------</div>
            </div>
            <div class="player-count"><span id="player-count-num">0</span> players joined</div>
            <div class="players-grid" id="players-list"></div>

            <div class="form-group">
                <label class="form-label">Answer Time (seconds)</label>
                <input type="number" id="answer-time-input" class="form-input" value="20" min="5" max="120">
                <div class="form-hint">Players have this much time to answer each question</div>
            </div>

            <div class="btn-group">
                <button id="start-game-btn" class="btn btn-primary" disabled>Start Game</button>
                <button id="end-session-btn" class="btn btn-danger">End Session</button>
            </div>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="card hidden">
            <div class="question-status" id="question-status">Question 1 of 5</div>
            <div class="answer-count" id="answer-count">0 / 0 answered</div>
            <div class="timer-container">
                <div class="timer-text" id="timer-text">20</div>
                <div class="timer-bar">
                    <div class="timer-bar-fill" id="timer-bar" style="width: 100%;"></div>
                </div>
            </div>
            <div class="question-text" id="question-text"></div>
            <div class="answers-display" id="answers-grid"></div>
            <div class="btn-group">
                <button id="show-results-btn" class="btn btn-primary">Show Results</button>
                <button id="end-session-question-btn" class="btn btn-danger">End Session</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="card hidden">
            <div class="leaderboard-title">üèÜ Leaderboard</div>
            <div id="leaderboard-list"></div>
            <div class="btn-group mt-3">
                <button id="next-question-btn" class="btn btn-primary">Next Question</button>
                <button id="end-session-results-btn" class="btn btn-danger">End Session</button>
            </div>
        </div>

        <!-- Final Results Screen -->
        <div id="final-screen" class="card hidden">
            <div class="leaderboard-title">üéâ Game Over!</div>
            <div id="final-leaderboard"></div>
            <button id="new-game-btn" class="btn btn-primary btn-full mt-3">New Game</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Ensure Socket.IO is loaded before initializing
        if (typeof io === 'undefined') {
            document.body.innerHTML = '<div style="text-align: center; margin-top: 50px; color: #fff;"><h1>Error</h1><p>Failed to load Socket.IO library. Please refresh the page.</p></div>';
            throw new Error('Socket.IO not loaded');
        }

        const socket = io();

        // Handle Socket.IO connection errors
        socket.on('connect_error', function (err) {
            document.body.innerHTML = '<div style="text-align: center; margin-top: 50px; color: #fff;"><h1>Connection Error</h1><p>Failed to connect to the server. Please check your internet connection and try again.</p></div>';
        });

        let currentPin = null;
        let customQuestions = [];
        let questionCounter = 0;
        let hostTimerInterval = null;
        let hostAnswerTimeLimit = 20;

        // PROMPT 1 ‚Äî Auto Show Results countdown state
        let autoShowResultsInterval = null;
        let autoShowResultsRemaining = 0;
        let defaultShowResultsLabel = 'Show Results';

        // PROMPT 3 ‚Äî Last question behavior state
        let isLastQuestion = false;
        let lastQuestionNumber = 0;
        let lastTotalQuestions = 0;

        // PROMPT 2 ‚Äî Question countdown overlay state
        let questionCountdownInterval = null;
        let questionCountdownRemaining = 0;

        // Configuration
        const MESSAGES = {
            endSessionConfirm: 'Are you sure you want to end this session? All progress will be lost.'
        };

        // Screen elements
        const quizSelectionScreen = document.getElementById('quiz-selection-screen');
        const quizCreationScreen = document.getElementById('quiz-creation-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const questionScreen = document.getElementById('question-screen');
        const resultsScreen = document.getElementById('results-screen');
        const finalScreen = document.getElementById('final-screen');

        // Quiz selection elements
        const useExampleBtn = document.getElementById('use-example-btn');
        const createCustomBtn = document.getElementById('create-custom-btn');

        // Quiz creation elements
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const createQuizBtn = document.getElementById('create-quiz-btn');
        const cancelQuizBtn = document.getElementById('cancel-quiz-btn');

        // Lobby elements
        const gamePinEl = document.getElementById('game-pin');
        const playerCountEl = document.getElementById('player-count-num');
        const playersListEl = document.getElementById('players-list');
        const startGameBtn = document.getElementById('start-game-btn');

        // Question elements
        const questionStatusEl = document.getElementById('question-status');
        const answerCountEl = document.getElementById('answer-count');
        const questionTextEl = document.getElementById('question-text');
        const answersGridEl = document.getElementById('answers-grid');
        const showResultsBtn = document.getElementById('show-results-btn');
        const timerTextEl = document.getElementById('timer-text');
        const timerBarEl = document.getElementById('timer-bar');

        // Results elements
        const leaderboardListEl = document.getElementById('leaderboard-list');
        const nextQuestionBtn = document.getElementById('next-question-btn');

        // End session buttons
        const endSessionBtn = document.getElementById('end-session-btn');
        const endSessionQuestionBtn = document.getElementById('end-session-question-btn');
        const endSessionResultsBtn = document.getElementById('end-session-results-btn');

        // New game button
        const newGameBtn = document.getElementById('new-game-btn');

        // Final elements
        const finalLeaderboardEl = document.getElementById('final-leaderboard');

        // PROMPT 2 ‚Äî Countdown overlay elements
        const countdownOverlayEl = document.getElementById('countdown-overlay');
        const countdownNumberEl = document.getElementById('countdown-number');

        // PROMPT 3 ‚Äî Next Question button defaults
        const DEFAULT_NEXT_QUESTION_LABEL = 'Next Question';
        const LAST_QUESTION_LABEL = 'Ana men√ºye d√∂n';

        // Quiz selection handlers
        useExampleBtn.addEventListener('click', () => {
            socket.emit('host-create-game');
        });

        createCustomBtn.addEventListener('click', () => {
            showScreen('quiz-creation');
            if (customQuestions.length === 0) {
                addQuestion();
            }
        });

        // Quiz creation handlers
        function addQuestion() {
            questionCounter++;
            const questionId = `q${questionCounter}`;

            const questionForm = document.createElement('div');
            questionForm.className = 'question-form';
            questionForm.dataset.questionId = questionId;
            questionForm.innerHTML = `
                <button class="remove-btn" data-question-id="${questionId}">‚úï</button>
                <h3>Question ${questionCounter}</h3>
                <div class="form-group">
                    <label class="form-label">Question Text</label>
                    <textarea class="form-input" placeholder="Enter your question here..." required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Answers (select the correct one)</label>
                    <div class="answer-grid">
                        <div class="answer-option red">
                            <input type="radio" name="${questionId}-correct" value="0" required>
                            <input type="text" placeholder="Answer 1" required>
                        </div>
                        <div class="answer-option blue">
                            <input type="radio" name="${questionId}-correct" value="1">
                            <input type="text" placeholder="Answer 2" required>
                        </div>
                        <div class="answer-option yellow">
                            <input type="radio" name="${questionId}-correct" value="2">
                            <input type="text" placeholder="Answer 3" required>
                        </div>
                        <div class="answer-option green">
                            <input type="radio" name="${questionId}-correct" value="3">
                            <input type="text" placeholder="Answer 4" required>
                        </div>
                    </div>
                </div>
            `;

            questionsContainer.appendChild(questionForm);

            const removeBtn = questionForm.querySelector('.remove-btn');
            removeBtn.addEventListener('click', () => {
                questionForm.remove();
                updateCreateQuizButton();
                renumberQuestions();
            });

            updateCreateQuizButton();
        }

        function renumberQuestions() {
            const forms = questionsContainer.querySelectorAll('.question-form');
            forms.forEach((form, index) => {
                form.querySelector('h3').textContent = `Question ${index + 1}`;
            });
            questionCounter = forms.length;
        }

        function updateCreateQuizButton() {
            const questionForms = questionsContainer.querySelectorAll('.question-form');
            createQuizBtn.disabled = questionForms.length === 0;
        }

        addQuestionBtn.addEventListener('click', addQuestion);

        cancelQuizBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to cancel? All questions will be lost.')) {
                questionsContainer.innerHTML = '';
                customQuestions = [];
                questionCounter = 0;
                showScreen('quiz-selection');
            }
        });

        createQuizBtn.addEventListener('click', () => {
            const questions = [];
            const questionForms = questionsContainer.querySelectorAll('.question-form');

            let isValid = true;
            questionForms.forEach((form, index) => {
                const questionText = form.querySelector('textarea').value.trim();
                const answerInputs = form.querySelectorAll('.answer-option input[type="text"]');
                const correctRadio = form.querySelector('input[type="radio"]:checked');

                if (!questionText) {
                    alert(`Question ${index + 1}: Please enter question text`);
                    isValid = false;
                    return;
                }

                const answers = Array.from(answerInputs).map(input => input.value.trim());
                if (answers.some(a => !a)) {
                    alert(`Question ${index + 1}: Please fill in all answers`);
                    isValid = false;
                    return;
                }

                if (!correctRadio) {
                    alert(`Question ${index + 1}: Please select the correct answer`);
                    isValid = false;
                    return;
                }

                questions.push({
                    question: questionText,
                    answers: answers,
                    correctAnswer: parseInt(correctRadio.value)
                });
            });

            if (isValid && questions.length > 0) {
                socket.emit('host-create-game', { questions: questions });
            }
        });

        // ============================
        //  1 ‚Äî Auto Show Results helpers
        // ============================
        function clearAutoShowResultsCountdown() {
            if (autoShowResultsInterval) {
                clearInterval(autoShowResultsInterval);
                autoShowResultsInterval = null;
            }
            autoShowResultsRemaining = 0;
            if (showResultsBtn) {
                showResultsBtn.textContent = defaultShowResultsLabel;
            }
        }

        function startAutoShowResultsCountdown() {
            clearAutoShowResultsCountdown();

            autoShowResultsRemaining = 3;
            showResultsBtn.textContent = `${defaultShowResultsLabel} in ${autoShowResultsRemaining}`;

            autoShowResultsInterval = setInterval(() => {
                autoShowResultsRemaining--;

                if (autoShowResultsRemaining > 0) {
                    showResultsBtn.textContent = `${defaultShowResultsLabel} in ${autoShowResultsRemaining}`;
                    return;
                }

                clearAutoShowResultsCountdown();
                socket.emit('host-show-results', { pin: currentPin });
            }, 1000);
        }

        // ============================
        //  2 ‚Äî Countdown overlay helpers
        // ============================
        function clearQuestionCountdownOverlay() {
            if (questionCountdownInterval) {
                clearInterval(questionCountdownInterval);
                questionCountdownInterval = null;
            }
            questionCountdownRemaining = 0;
            if (countdownOverlayEl) countdownOverlayEl.classList.add('hidden');
        }

        function animateCountdownNumber() {
            if (!countdownNumberEl) return;
            countdownNumberEl.classList.remove('animate');
            void countdownNumberEl.offsetWidth; // force reflow
            countdownNumberEl.classList.add('animate');
        }

        function showCountdown(seconds) {
            const s = parseInt(seconds, 10);
            const startSeconds = Number.isFinite(s) && s > 0 ? s : 3;

            if (!countdownOverlayEl || !countdownNumberEl) return;

            clearQuestionCountdownOverlay();

            questionCountdownRemaining = startSeconds;
            countdownOverlayEl.classList.remove('hidden');
            countdownNumberEl.textContent = String(questionCountdownRemaining);
            animateCountdownNumber();

            questionCountdownInterval = setInterval(() => {
                questionCountdownRemaining--;

                if (questionCountdownRemaining <= 0) {
                    clearQuestionCountdownOverlay();
                    return;
                }

                countdownNumberEl.textContent = String(questionCountdownRemaining);
                animateCountdownNumber();
            }, 1000);
        }

        function applyScreenFadeIn(el) {
            if (!el) return;
            el.classList.remove('screen-fade-in');
            void el.offsetWidth; // force reflow
            el.classList.add('screen-fade-in');
            setTimeout(() => el.classList.remove('screen-fade-in'), 350);
        }

        // ============================
        //  3 ‚Äî Next Question button helpers
        // ============================
        function setNextQuestionButtonToDefault() {
            nextQuestionBtn.textContent = DEFAULT_NEXT_QUESTION_LABEL;
            nextQuestionBtn.classList.remove('btn-success', 'btn-danger');
            nextQuestionBtn.classList.add('btn-primary');
            nextQuestionBtn.disabled = false;
        }

        function setNextQuestionButtonToReturnMenu() {
            nextQuestionBtn.textContent = LAST_QUESTION_LABEL;
            nextQuestionBtn.classList.remove('btn-primary', 'btn-danger');
            nextQuestionBtn.classList.add('btn-success');
            nextQuestionBtn.disabled = false;
        }

        // Game created
        socket.on('game-created', (data) => {
            currentPin = data.pin;
            gamePinEl.textContent = data.pin;
            showScreen('lobby');
            console.log('Game created with PIN:', data.pin);
        });

        // Player joined
        socket.on('player-joined', (data) => {
            updatePlayersList(data.players);
            startGameBtn.disabled = Object.keys(data.players).length === 0;
        });

        // Player left
        socket.on('player-left', (data) => {
            updatePlayersList(data.players);
            startGameBtn.disabled = Object.keys(data.players).length === 0;
        });

        // Start game
        startGameBtn.addEventListener('click', () => {
            const answerTimeInput = document.getElementById('answer-time-input');
            const answerTimeLimit = parseInt(answerTimeInput.value) || 20;
            hostAnswerTimeLimit = answerTimeLimit;
            socket.emit('host-start-game', { pin: currentPin, answerTimeLimit: answerTimeLimit });
        });

        //  2: Receive synchronized countdown event
        socket.on('question-countdown', ({ seconds }) => {
            showCountdown(seconds);
        });

        // Question display
        socket.on('question-display', (data) => {
            //  1: reset/clear countdown and button state BEFORE showing question
            clearAutoShowResultsCountdown();
            showResultsBtn.textContent = defaultShowResultsLabel;
            showResultsBtn.disabled = false;

            //  3: reset last-question state on new question
            isLastQuestion = false;
            setNextQuestionButtonToDefault();

            //  2: ensure overlay is not stuck visible
            clearQuestionCountdownOverlay();

            // Track question meta for fallback last-question detection
            lastQuestionNumber = data.questionNumber || 0;
            lastTotalQuestions = data.totalQuestions || 0;

            questionStatusEl.textContent = `Question ${data.questionNumber} of ${data.totalQuestions}`;
            questionTextEl.textContent = data.question;
            answerCountEl.textContent = `0 / ${data.totalPlayers || 0} answered`;

            hostAnswerTimeLimit = data.answerTimeLimit || 20;

            // Show timer again
            const timerContainer = document.querySelector('.timer-container');
            if (timerContainer) timerContainer.classList.remove('hidden');

            startHostTimer(hostAnswerTimeLimit);

            const colors = ['red', 'blue', 'yellow', 'green'];
            answersGridEl.innerHTML = data.answers.map((answer, index) =>
                `<div class="answer-box ${colors[index]}">${answer}</div>`
            ).join('');

            showScreen('question');
            //  2: fade-in question screen
            applyScreenFadeIn(questionScreen);
        });

        // Answer count update
        socket.on('answer-count-update', (data) => {
            answerCountEl.textContent = `${data.answered} / ${data.total} answered`;
        });

        function startHostTimer(duration) {
            if (hostTimerInterval) clearInterval(hostTimerInterval);

            let timeLeft = duration;
            timerTextEl.textContent = timeLeft;
            timerTextEl.className = 'timer-text';
            timerBarEl.style.width = '100%';

            hostTimerInterval = setInterval(() => {
                timeLeft--;
                timerTextEl.textContent = timeLeft;

                const percentage = (timeLeft / duration) * 100;
                timerBarEl.style.width = percentage + '%';

                if (timeLeft <= 5) {
                    timerTextEl.className = 'timer-text danger';
                } else if (timeLeft <= 10) {
                    timerTextEl.className = 'timer-text warning';
                }

                if (timeLeft <= 0) {
                    clearInterval(hostTimerInterval);
                    timerTextEl.textContent = '0';
                }
            }, 1000);
        }

        // Show results button
        showResultsBtn.addEventListener('click', () => {
            //  1: manual click cancels auto countdown
            clearAutoShowResultsCountdown();

            if (hostTimerInterval) clearInterval(hostTimerInterval);
            socket.emit('host-show-results', { pin: currentPin });
        });

        // Answer revealed (when timer expires or all players answered)
        socket.on('answer-revealed', (data) => {
            if (hostTimerInterval) clearInterval(hostTimerInterval);

            // Hide timer
            const timerContainer = document.querySelector('.timer-container');
            if (timerContainer) timerContainer.classList.add('hidden');

            const answerBoxes = answersGridEl.querySelectorAll('.answer-box');
            answerBoxes.forEach((box, index) => {
                if (index === data.correctAnswer) {
                    box.classList.add('correct');
                }
            });

            //  1: start auto "Show Results in 3-2-1"
            startAutoShowResultsCountdown();
        });

        // Question results (when host clicks Show Results)
        socket.on('question-results', (data) => {
            const answerBoxes = answersGridEl.querySelectorAll('.answer-box');
            answerBoxes.forEach((box, index) => {
                if (index === data.correctAnswer) {
                    box.classList.add('correct');
                }
            });

            //  3: detect last question & update Next Question button BEFORE switching screens
            const hasIsLast = typeof data.isLastQuestion === 'boolean';
            const qn = (typeof data.questionNumber === 'number' ? data.questionNumber : lastQuestionNumber);
            const tq = (typeof data.totalQuestions === 'number' ? data.totalQuestions : lastTotalQuestions);

            if (hasIsLast) {
                isLastQuestion = !!data.isLastQuestion;
            } else if (qn && tq) {
                isLastQuestion = (qn === tq);
            } else {
                isLastQuestion = false;
            }

            if (isLastQuestion) {
                setNextQuestionButtonToReturnMenu();
            } else {
                setNextQuestionButtonToDefault();
            }

            setTimeout(() => {
                updateLeaderboard(data.leaderboard);
                showScreen('results');
                applyScreenFadeIn(resultsScreen);
            }, 1500);
        });

        // Next question / Return to menu
        nextQuestionBtn.addEventListener('click', () => {
            if (isLastQuestion) {
                nextQuestionBtn.disabled = true;

                clearAutoShowResultsCountdown();
                clearQuestionCountdownOverlay();
                if (hostTimerInterval) clearInterval(hostTimerInterval);

                socket.emit('host-end-session', { pin: currentPin });

                // Short delay, then back to menu
                setTimeout(() => {
                    window.location.href = '/';
                }, 400);
                return;
            }

            socket.emit('host-next-question', { pin: currentPin });
        });

        // Game ended
        socket.on('game-ended', (data) => {
            clearAutoShowResultsCountdown();
            clearQuestionCountdownOverlay();

            if (hostTimerInterval) clearInterval(hostTimerInterval);
            updateFinalLeaderboard(data.leaderboard);
            showScreen('final');
            applyScreenFadeIn(finalScreen);
        });

        // End session handlers
        function endSession() {
            if (confirm(MESSAGES.endSessionConfirm)) {
                clearAutoShowResultsCountdown();
                clearQuestionCountdownOverlay();

                if (hostTimerInterval) clearInterval(hostTimerInterval);
                socket.emit('host-end-session', { pin: currentPin });
                location.reload();
            }
        }

        endSessionBtn.addEventListener('click', endSession);
        endSessionQuestionBtn.addEventListener('click', endSession);
        endSessionResultsBtn.addEventListener('click', endSession);

        // New game
        newGameBtn.addEventListener('click', () => {
            location.reload();
        });

        // Update players list
        function updatePlayersList(players) {
            const playerArray = Object.values(players);
            playerCountEl.textContent = playerArray.length;

            playersListEl.innerHTML = playerArray.map(player =>
                `<div class="player-chip">
                    <span>${player.nickname}</span>
                </div>`
            ).join('');
        }

        // Update leaderboard
        function updateLeaderboard(leaderboard) {
            leaderboardListEl.innerHTML = leaderboard.map((player, index) =>
                `<div class="leaderboard-item">
                    <div class="leaderboard-rank">${index + 1}</div>
                    <div class="leaderboard-name">${player.nickname}</div>
                    <div class="leaderboard-score">${player.score}</div>
                </div>`
            ).join('');
        }

        // Update final leaderboard
        function updateFinalLeaderboard(leaderboard) {
            finalLeaderboardEl.innerHTML = leaderboard.map((player, index) =>
                `<div class="leaderboard-item">
                    <div class="leaderboard-rank">${index + 1}</div>
                    <div class="leaderboard-name">${player.nickname}</div>
                    <div class="leaderboard-score">${player.score}</div>
                </div>`
            ).join('');
        }

        function showScreen(screen) {
            quizSelectionScreen.classList.add('hidden');
            quizCreationScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            questionScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            finalScreen.classList.add('hidden');

            switch (screen) {
                case 'quiz-selection':
                    quizSelectionScreen.classList.remove('hidden');
                    break;
                case 'quiz-creation':
                    quizCreationScreen.classList.remove('hidden');
                    break;
                case 'lobby':
                    lobbyScreen.classList.remove('hidden');
                    break;
                case 'question':
                    questionScreen.classList.remove('hidden');
                    break;
                case 'results':
                    resultsScreen.classList.remove('hidden');
                    break;
                case 'final':
                    finalScreen.classList.remove('hidden');
                    break;
            }
        }

        // Error handling
        socket.on('error', (data) => {
            alert('Error: ' + data.message);
        });

        socket.on('host-disconnected', () => {
            alert('Host disconnected. Game ended.');
            location.reload();
        });
    </script>
</body>

</html>
