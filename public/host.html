<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hohohoot - Host</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .pin-display {
            background: #f7f7f7;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .pin-label {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        .pin-number {
            font-size: 4em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 10px;
        }

        .player-count {
            font-size: 1.5em;
            color: #764ba2;
            margin: 20px 0;
        }

        .players-list {
            background: #f7f7f7;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-name {
            font-weight: bold;
            color: #333;
        }

        .player-score {
            color: #667eea;
            font-weight: bold;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .question-display {
            background: #f7f7f7;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .question-text {
            font-size: 2em;
            color: #333;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .answer-box {
            padding: 20px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
        }

        .answer-box.red { background: #e74c3c; }
        .answer-box.blue { background: #3498db; }
        .answer-box.yellow { background: #f1c40f; color: #333; }
        .answer-box.green { background: #2ecc71; }

        .answer-box.correct {
            animation: pulse 0.5s ease;
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.8);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .leaderboard {
            background: #f7f7f7;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .leaderboard-title {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .leaderboard-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .leaderboard-rank {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            width: 60px;
        }

        .leaderboard-name {
            flex: 1;
            text-align: left;
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .leaderboard-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #764ba2;
        }

        .hidden {
            display: none;
        }

        .status-message {
            font-size: 1.2em;
            color: #666;
            margin: 20px 0;
        }

        .question-form {
            background: #f7f7f7;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            position: relative;
        }

        .question-form h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group input[type="text"]:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .answer-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .answer-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .answer-input-wrapper input[type="radio"] {
            cursor: pointer;
        }

        .answer-input-wrapper input[type="text"] {
            flex: 1;
        }

        .remove-question-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .remove-question-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Hohohoot Host</h1>

        <!-- Quiz Selection Screen -->
        <div id="quiz-selection-screen">
            <h2 style="color: #667eea; margin-bottom: 30px;">Choose Your Quiz</h2>
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <button id="use-example-btn" style="background: #2ecc71;">üìö Use Example Quiz</button>
                <button id="create-custom-btn" style="background: #e74c3c;">‚úèÔ∏è Create Custom Quiz</button>
            </div>
        </div>

        <!-- Custom Quiz Creation Screen -->
        <div id="quiz-creation-screen" class="hidden">
            <h2 style="color: #667eea; margin-bottom: 20px;">Create Your Quiz</h2>
            <div id="questions-container" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Questions will be added here -->
            </div>
            <button id="add-question-btn" style="background: #2ecc71; margin: 10px;">‚ûï Add Question</button>
            <div style="margin-top: 20px;">
                <button id="create-quiz-btn" disabled>Create Quiz & Start Game</button>
                <button id="cancel-quiz-btn" class="danger">Cancel</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden">
            <div class="pin-display">
                <div class="pin-label">Game PIN:</div>
                <div class="pin-number" id="game-pin">------</div>
            </div>
            <div class="player-count" id="player-count">0 players joined</div>
            <div class="players-list" id="players-list"></div>
            <button id="start-game-btn" disabled>Start Game</button>
            <button id="end-session-btn" class="danger">End Session</button>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="hidden">
            <div class="status-message" id="question-status">Question 1 of 5</div>
            <div class="question-display">
                <div class="question-text" id="question-text"></div>
                <div class="answers-grid" id="answers-grid"></div>
            </div>
            <button id="show-results-btn">Show Results</button>
            <button id="end-session-question-btn" class="danger">End Session</button>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden">
            <div class="leaderboard">
                <div class="leaderboard-title">üèÜ Leaderboard</div>
                <div id="leaderboard-list"></div>
            </div>
            <button id="next-question-btn">Next Question</button>
            <button id="end-session-results-btn" class="danger">End Session</button>
        </div>

        <!-- Final Results Screen -->
        <div id="final-screen" class="hidden">
            <h2 style="color: #667eea; margin-bottom: 30px;">üéâ Game Over!</h2>
            <div class="leaderboard">
                <div class="leaderboard-title">üèÜ Final Standings</div>
                <div id="final-leaderboard"></div>
            </div>
            <button id="new-game-btn">New Game</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Ensure Socket.IO is loaded before initializing
        if (typeof io === 'undefined') {
            document.body.innerHTML = '<div style="text-align: center; margin-top: 50px; font-family: Arial;"><h1>Error</h1><p>Failed to load Socket.IO library. Please refresh the page.</p></div>';
            throw new Error('Socket.IO not loaded');
        }
        
        const socket = io();
        // Handle Socket.IO connection errors
        socket.on('connect_error', function (err) {
            document.body.innerHTML = '<div style="text-align: center; margin-top: 50px; font-family: Arial;"><h1>Connection Error</h1><p>Failed to connect to the server. Please check your internet connection and try again.</p></div>';
        });
        let currentPin = null;
        let customQuestions = [];
        let questionCounter = 0;

        // Configuration
        const MESSAGES = {
            endSessionConfirm: 'Are you sure you want to end this session? All progress will be lost.'
        };

        // Screen elements
        const quizSelectionScreen = document.getElementById('quiz-selection-screen');
        const quizCreationScreen = document.getElementById('quiz-creation-screen');
        const lobbyScreen = document.getElementById('lobby-screen');
        const questionScreen = document.getElementById('question-screen');
        const resultsScreen = document.getElementById('results-screen');
        const finalScreen = document.getElementById('final-screen');

        // Quiz selection elements
        const useExampleBtn = document.getElementById('use-example-btn');
        const createCustomBtn = document.getElementById('create-custom-btn');

        // Quiz creation elements
        const questionsContainer = document.getElementById('questions-container');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const createQuizBtn = document.getElementById('create-quiz-btn');
        const cancelQuizBtn = document.getElementById('cancel-quiz-btn');

        // Lobby elements
        const gamePinEl = document.getElementById('game-pin');
        const playerCountEl = document.getElementById('player-count');
        const playersListEl = document.getElementById('players-list');
        const startGameBtn = document.getElementById('start-game-btn');

        // Question elements
        const questionStatusEl = document.getElementById('question-status');
        const questionTextEl = document.getElementById('question-text');
        const answersGridEl = document.getElementById('answers-grid');
        const showResultsBtn = document.getElementById('show-results-btn');

        // Results elements
        const leaderboardListEl = document.getElementById('leaderboard-list');
        const nextQuestionBtn = document.getElementById('next-question-btn');

        // End session buttons
        const endSessionBtn = document.getElementById('end-session-btn');
        const endSessionQuestionBtn = document.getElementById('end-session-question-btn');
        const endSessionResultsBtn = document.getElementById('end-session-results-btn');
        
        // New game button
        const newGameBtn = document.getElementById('new-game-btn');

        // Final elements
        const finalLeaderboardEl = document.getElementById('final-leaderboard');

        // Quiz selection handlers
        useExampleBtn.addEventListener('click', () => {
            // Create game with example quiz (no questions parameter)
            socket.emit('host-create-game');
        });

        createCustomBtn.addEventListener('click', () => {
            showScreen('quiz-creation');
            // Add first question automatically
            if (customQuestions.length === 0) {
                addQuestion();
            }
        });

        // Quiz creation handlers
        function addQuestion() {
            questionCounter++;
            const questionId = `q${questionCounter}`;
            
            const questionForm = document.createElement('div');
            questionForm.className = 'question-form';
            questionForm.dataset.questionId = questionId;
            questionForm.innerHTML = `
                <button class="remove-question-btn" data-question-id="${questionId}">‚úï</button>
                <h3>Question ${questionCounter}</h3>
                <div class="form-group">
                    <label>Question Text:</label>
                    <textarea placeholder="Enter your question here..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Answers (select the correct one):</label>
                    <div class="answer-inputs">
                        <div class="answer-input-wrapper">
                            <input type="radio" name="${questionId}-correct" value="0" required>
                            <input type="text" placeholder="Answer 1 (Red)" required style="border-left: 4px solid #e74c3c;">
                        </div>
                        <div class="answer-input-wrapper">
                            <input type="radio" name="${questionId}-correct" value="1">
                            <input type="text" placeholder="Answer 2 (Blue)" required style="border-left: 4px solid #3498db;">
                        </div>
                        <div class="answer-input-wrapper">
                            <input type="radio" name="${questionId}-correct" value="2">
                            <input type="text" placeholder="Answer 3 (Yellow)" required style="border-left: 4px solid #f1c40f;">
                        </div>
                        <div class="answer-input-wrapper">
                            <input type="radio" name="${questionId}-correct" value="3">
                            <input type="text" placeholder="Answer 4 (Green)" required style="border-left: 4px solid #2ecc71;">
                        </div>
                    </div>
                </div>
            `;
            
            questionsContainer.appendChild(questionForm);
            
            // Add event listener for remove button
            const removeBtn = questionForm.querySelector('.remove-question-btn');
            removeBtn.addEventListener('click', () => {
                questionForm.remove();
                updateCreateQuizButton();
                renumberQuestions();
            });
            
            updateCreateQuizButton();
        }

        function renumberQuestions() {
            const forms = questionsContainer.querySelectorAll('.question-form');
            forms.forEach((form, index) => {
                form.querySelector('h3').textContent = `Question ${index + 1}`;
            });
        }

        function updateCreateQuizButton() {
            const questionForms = questionsContainer.querySelectorAll('.question-form');
            createQuizBtn.disabled = questionForms.length === 0;
        }

        addQuestionBtn.addEventListener('click', addQuestion);

        cancelQuizBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to cancel? All questions will be lost.')) {
                questionsContainer.innerHTML = '';
                customQuestions = [];
                questionCounter = 0;
                showScreen('quiz-selection');
            }
        });

        createQuizBtn.addEventListener('click', () => {
            const questions = [];
            const questionForms = questionsContainer.querySelectorAll('.question-form');
            
            let isValid = true;
            questionForms.forEach((form, index) => {
                const questionText = form.querySelector('textarea').value.trim();
                const answerInputs = form.querySelectorAll('.answer-input-wrapper input[type="text"]');
                const correctRadio = form.querySelector('input[type="radio"]:checked');
                
                if (!questionText) {
                    alert(`Question ${index + 1}: Please enter question text`);
                    isValid = false;
                    return;
                }
                
                const answers = Array.from(answerInputs).map(input => input.value.trim());
                if (answers.some(a => !a)) {
                    alert(`Question ${index + 1}: Please fill in all answers`);
                    isValid = false;
                    return;
                }
                
                if (!correctRadio) {
                    alert(`Question ${index + 1}: Please select the correct answer`);
                    isValid = false;
                    return;
                }
                
                questions.push({
                    question: questionText,
                    answers: answers,
                    correctAnswer: parseInt(correctRadio.value)
                });
            });
            
            if (isValid && questions.length > 0) {
                // Create game with custom questions
                socket.emit('host-create-game', { questions: questions });
            }
        });

        // Create game on load - REMOVED, now we show quiz selection instead
        // socket.emit('host-create-game');

        // Game created
        socket.on('game-created', (data) => {
            currentPin = data.pin;
            gamePinEl.textContent = data.pin;
            showScreen('lobby');
            console.log('Game created with PIN:', data.pin);
        });

        // Player joined
        socket.on('player-joined', (data) => {
            updatePlayersList(data.players);
            playerCountEl.textContent = `${data.playerCount} player${data.playerCount !== 1 ? 's' : ''} joined`;
            startGameBtn.disabled = data.playerCount === 0;
        });

        // Player left
        socket.on('player-left', (data) => {
            updatePlayersList(data.players);
            playerCountEl.textContent = `${data.playerCount} player${data.playerCount !== 1 ? 's' : ''} joined`;
            startGameBtn.disabled = data.playerCount === 0;
        });

        function updatePlayersList(players) {
            playersListEl.innerHTML = '';
            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                playerItem.innerHTML = `
                    <span class="player-name">${player.nickname}</span>
                    <span class="player-score">${player.score} pts</span>
                `;
                playersListEl.appendChild(playerItem);
            });
        }

        // Start game
        startGameBtn.addEventListener('click', () => {
            socket.emit('host-start-game', { pin: currentPin });
        });

        // Display question
        socket.on('question-display', (data) => {
            showScreen('question');
            questionStatusEl.textContent = `Question ${data.questionNumber} of ${data.totalQuestions}`;
            questionTextEl.textContent = data.question;
            
            answersGridEl.innerHTML = '';
            const colors = ['red', 'blue', 'yellow', 'green'];
            data.answers.forEach((answer, index) => {
                const answerBox = document.createElement('div');
                answerBox.className = `answer-box ${colors[index]}`;
                answerBox.textContent = answer;
                answersGridEl.appendChild(answerBox);
            });
        });

        // Show results
        showResultsBtn.addEventListener('click', () => {
            socket.emit('host-show-results', { pin: currentPin });
        });

        // Display results
        socket.on('question-results', (data) => {
            showScreen('results');
            
            // Highlight correct answer in question screen
            const answerBoxes = answersGridEl.querySelectorAll('.answer-box');
            answerBoxes[data.correctAnswer].classList.add('correct');
            
            // Update leaderboard
            updateLeaderboard(leaderboardListEl, data.leaderboard);
        });

        // Next question
        nextQuestionBtn.addEventListener('click', () => {
            socket.emit('host-next-question', { pin: currentPin });
        });

        // End session handlers
        function handleEndSession() {
            if (confirm(MESSAGES.endSessionConfirm)) {
                socket.emit('host-end-session', { pin: currentPin });
            }
        }

        endSessionBtn.addEventListener('click', handleEndSession);
        endSessionQuestionBtn.addEventListener('click', handleEndSession);
        endSessionResultsBtn.addEventListener('click', handleEndSession);
        
        // New game handler
        newGameBtn.addEventListener('click', () => {
            location.reload();
        });

        // Game ended
        socket.on('game-ended', (data) => {
            showScreen('final');
            updateLeaderboard(finalLeaderboardEl, data.leaderboard);
        });

        function updateLeaderboard(container, leaderboard) {
            container.innerHTML = '';
            leaderboard.forEach(player => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="leaderboard-rank">${player.rank}</div>
                    <div class="leaderboard-name">${player.nickname}</div>
                    <div class="leaderboard-score">${player.score}</div>
                `;
                container.appendChild(item);
            });
        }

        function showScreen(screen) {
            quizSelectionScreen.classList.add('hidden');
            quizCreationScreen.classList.add('hidden');
            lobbyScreen.classList.add('hidden');
            questionScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            finalScreen.classList.add('hidden');

            switch(screen) {
                case 'quiz-selection':
                    quizSelectionScreen.classList.remove('hidden');
                    break;
                case 'quiz-creation':
                    quizCreationScreen.classList.remove('hidden');
                    break;
                case 'lobby':
                    lobbyScreen.classList.remove('hidden');
                    break;
                case 'question':
                    questionScreen.classList.remove('hidden');
                    break;
                case 'results':
                    resultsScreen.classList.remove('hidden');
                    break;
                case 'final':
                    finalScreen.classList.remove('hidden');
                    break;
            }
        }

        // Error handling
        socket.on('error', (data) => {
            alert('Error: ' + data.message);
        });

        socket.on('host-disconnected', () => {
            alert('Host disconnected. Game ended.');
            location.reload();
        });
    </script>
</body>
</html>
